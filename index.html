<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Моя карта стран — посещено и альбомы</title>
  <style>
    body { background:#0f1115; color:#e6e6e6; font-family:system-ui; margin:0; }
    h1 { font-size:18px; margin:0 0 8px; }
    .wrap { display:grid; grid-template-rows:auto 1fr auto; min-height:100vh; }
    header,footer { padding:12px 16px; background:#171a21; border-bottom:1px solid #2a2f3a; }
    footer { border-top:1px solid #2a2f3a; border-bottom:none; font-size:13px; color:#9aa3b2; }
    svg { width:100%; height:auto; display:block; }
    .country { fill:#374151; stroke:#0f1115; stroke-width:0.5; cursor:pointer; transition:fill .2s; }
    .country:hover { stroke:#a7f3d0; stroke-width:1; }
    .legend { position:absolute; right:10px; bottom:10px; background:rgba(0,0,0,.4); padding:8px 12px; border-radius:8px; font-size:14px; }
    .sw { display:inline-block; width:14px; height:14px; margin-right:4px; vertical-align:middle; border-radius:3px; }
  </style>
</head>
<body>
<div class="wrap">
<header>
  <h1>Контурная карта мира: посещено и фотоальбомы</h1>
  <p>Клик по стране: Не посещено → Посещено → Есть альбом. Двойной клик открывает альбом.</p>
</header>
<main style="position:relative; padding:8px;">
  <div id="map"></div>
  <div class="legend">
    <div><span class="sw" style="background:#374151;"></span>Не посещено</div>
    <div><span class="sw" style="background:#4f86ff;"></span>Посещено</div>
    <div><span class="sw" style="background:#f0b429;"></span>Есть альбом</div>
  </div>
</main>
<footer>
  <p>Данные сохраняются локально (localStorage). Экспорт/импорт доступны в расширенной версии.</p>
</footer>
</div>
<script src="https://unpkg.com/d3@7"></script>
<script>
const WORLD_URL="https://cdn.jsdelivr.net/npm/world-countries@4/countries.geo.json";
const mapEl=d3.select("#map"),width=1200,height=600;
const svg=mapEl.append("svg").attr("viewBox",`0 0 ${width} ${height}`);
const g=svg.append("g");
const projection=d3.geoMercator().scale(width/6.3).translate([width/2,height/1.4]);
const path=d3.geoPath(projection);
let states=JSON.parse(localStorage.getItem("visitedMap.v1.states")||"{}");
const colors=["#374151","#4f86ff","#f0b429"];
function get(cca3){return states[cca3]||{state:0};}
function save(){localStorage.setItem("visitedMap.v1.states",JSON.stringify(states));}
function colorFor(cca3){return colors[get(cca3).state];}
function setState(cca3,n){states[cca3]={state:n};if(n==0)delete states[cca3];save();update();}
function cycle(cca3,name){
  const s=get(cca3).state;
  const n=(s+1)%3;
  if(n==2){const u=prompt("Ссылка на альбом для "+name,get(cca3).album||"");states[cca3]={state:2,album:u||null};}
  else setState(cca3,n);
  save();update();
}
function update(){
  g.selectAll("path").attr("fill",d=>colorFor(d.properties.cca3));
}
d3.json(WORLD_URL).then(data=>{
  const features=data.features.filter(f=>f.properties.name!=="Antarctica");
  g.selectAll("path").data(features).enter().append("path")
    .attr("class","country").attr("d",path)
    .attr("fill",d=>colorFor(d.properties.cca3))
    .on("click",(e,d)=>cycle(d.properties.cca3,d.properties.name))
    .on("dblclick",(e,d)=>{const s=get(d.properties.cca3);if(s.state==2&&s.album)window.open(s.album,"_blank");});
});
</script>
</body>
</html>