<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Карта посещённых стран</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#171a21;--text:#e6e6e6;--muted:#9aa3b2;--border:#2a2f3a;
      --base:#374151;--visited:#4f86ff;--album:#f0b429;
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial;}
    header{background:var(--panel);border-bottom:1px solid var(--border);padding:10px 14px;position:sticky;top:0;z-index:5}
    h1{font-size:18px;margin:0 0 6px}
    main{padding:10px}
    .status{font-size:13px;color:var(--muted)}
    #map svg{width:100%;height:auto;display:block}
    .country{fill:var(--base);stroke:#0c0e13;stroke-width:.5;cursor:pointer;transition:fill .2s, stroke .2s}
    .country:hover{stroke:#a7f3d0;stroke-width:1}
    .legend{position:fixed;right:10px;bottom:10px;background:rgba(0,0,0,.45);padding:8px 12px;border-radius:10px;font-size:14px}
    .sw{display:inline-block;width:14px;height:14px;border-radius:3px;margin-right:6px;vertical-align:-2px}
    .row{display:flex;gap:14px;align-items:center}
    .bad{color:#ff8080}
    .counters{margin-top:8px;font-size:14px;display:flex;gap:18px;flex-wrap:wrap}
    .badge{background:rgba(255,255,255,.05);border:1px solid var(--border);padding:4px 10px;border-radius:999px}
  </style>
</head>
<body>
<header>
  <h1>Контурная карта мира</h1>
  <div class="status">Клик по стране: <b>Не посещено → Посещено → Есть альбом</b>. Двойной клик открывает альбом.</div>
  <div class="counters">
    <span class="badge">Всего: <b id="total">—</b></span>
    <span class="badge">Посещено: <b id="vcount">—</b></span>
    <span class="badge">С альбомом: <b id="acount">—</b></span>
  </div>
  <div id="err" class="status bad" style="display:none"></div>
</header>
<main>
  <div id="map"></div>
</main>
<div class="legend">
  <div class="row"><span class="sw" style="background:var(--base)"></span>Не посещено</div>
  <div class="row"><span class="sw" style="background:var(--visited)"></span>Посещено</div>
  <div class="row"><span class="sw" style="background:var(--album)"></span>Есть альбом</div>
</div>
<script src="https://unpkg.com/d3@7"></script>
<script>
// Two CDNs for the world geojson, with fallback
const GEO_URLS = [
  "https://unpkg.com/world-countries@4/countries.geo.json",
  "https://cdn.jsdelivr.net/npm/world-countries@4/countries.geo.json"
];

const mapEl = d3.select("#map");
const errEl = document.getElementById("err");
const totalEl = document.getElementById("total");
const vEl = document.getElementById("vcount");
const aEl = document.getElementById("acount");

const width = Math.min(1400, mapEl.node().clientWidth || 1200);
const height = Math.round(width * 0.52);

const svg = mapEl.append("svg").attr("viewBox", `0 0 ${width} ${height}`);
const g = svg.append("g");
const projection = d3.geoMercator().scale((width/2/Math.PI)*1.07).translate([width/2, height/1.58]);
const path = d3.geoPath(projection);

const COLORS = ["var(--base)", "var(--visited)", "var(--album)"];
let states = JSON.parse(localStorage.getItem("visitedMap.v1.states") || "{}");

function get(cca3){ return states[cca3] || {state:0}; }
function save(){ localStorage.setItem("visitedMap.v1.states", JSON.stringify(states)); }
function fill(cca3){ return COLORS[get(cca3).state]; }
function count(){ 
  const vals = Object.values(states);
  vEl.textContent = vals.filter(v => v.state>=1).length;
  aEl.textContent = vals.filter(v => v.state===2).length;
}

function cycle(cca3, name){
  const s = get(cca3).state;
  const n = (s + 1) % 3;
  if(n===2){
    const u = prompt("Ссылка на альбом Google Фото для: "+name, get(cca3).album||"");
    states[cca3] = {state:2, album: (u||"") || null};
  }else{
    states[cca3] = {state:n};
    if(n===0) delete states[cca3];
  }
  save();
  g.selectAll("path.country").filter(d => d.properties.cca3===cca3).attr("fill", fill(cca3));
  count();
}

async function loadWorld(){
  let lastErr;
  for(const url of GEO_URLS){
    try{
      const res = await fetch(url, {mode:"cors"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data = await res.json();
      return data;
    }catch(e){
      lastErr = e;
    }
  }
  throw lastErr || new Error("Не удалось загрузить world geojson");
}

loadWorld().then(data => {
  const features = data.features.filter(f => f.properties && f.properties.name !== "Antarctica");
  totalEl.textContent = features.length;
  g.selectAll("path.country").data(features).enter()
    .append("path")
      .attr("class","country")
      .attr("d", path)
      .attr("fill", d => fill(d.properties.cca3))
      .on("click", (ev,d) => cycle(d.properties.cca3, d.properties.name))
      .on("dblclick", (ev,d) => {
        const s = get(d.properties.cca3);
        if(s.state===2 && s.album){ window.open(s.album, "_blank"); }
      });
  count();
}).catch(e => {
  console.error(e);
  errEl.style.display = "block";
  errEl.textContent = "Не удалось загрузить карту стран (внешний CDN заблокирован?). Откройте страницу в другом браузере/сети или используйте офлайн-версию.";
});
</script>
</body>
</html>
